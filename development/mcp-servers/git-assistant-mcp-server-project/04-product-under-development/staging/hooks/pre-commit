#!/bin/bash
# Git Pre-Commit Hook - Security & Compliance Integration
# Managed by git-assistant-mcp and security-compliance-mcp
#
# This hook runs before every commit to:
# 1. Scan for credentials (API keys, tokens, passwords)
# 2. Scan for PHI (Protected Health Information)
# 3. Check commit readiness
#
# To bypass this hook in emergencies: git commit --no-verify
# (Not recommended - only use for urgent fixes)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
REPO_ROOT=$(git rev-parse --show-toplevel)
CONFIG_FILE="$REPO_ROOT/.git-security-config.json"
SECURITY_ENABLED=true
SCAN_CREDENTIALS=true
SCAN_PHI=true

# Load configuration if exists
if [ -f "$CONFIG_FILE" ]; then
  SECURITY_ENABLED=$(jq -r '.enabled // true' "$CONFIG_FILE" 2>/dev/null || echo "true")
  SCAN_CREDENTIALS=$(jq -r '.scanCredentials // true' "$CONFIG_FILE" 2>/dev/null || echo "true")
  SCAN_PHI=$(jq -r '.scanPHI // true' "$CONFIG_FILE" 2>/dev/null || echo "true")
fi

# Check if security scanning is enabled
if [ "$SECURITY_ENABLED" != "true" ]; then
  echo -e "${YELLOW}âš ï¸  Security scanning disabled${NC}"
  exit 0
fi

echo -e "${BLUE}ğŸ”’ Running security checks...${NC}"

# Temporary files for results
CRED_RESULTS=$(mktemp)
PHI_RESULTS=$(mktemp)
COMMIT_CHECK=$(mktemp)

# Cleanup on exit
trap 'rm -f "$CRED_RESULTS" "$PHI_RESULTS" "$COMMIT_CHECK"' EXIT

# Track if any checks failed
FAILED=false

# Run credential scan if enabled
if [ "$SCAN_CREDENTIALS" = "true" ]; then
  echo -e "${BLUE}  â†’ Scanning for credentials...${NC}"

  # Simple pattern-based scanning (MVP)
  # In production, this would call security-compliance-mcp
  git diff --cached --name-only | while read -r file; do
    if [ -f "$file" ]; then
      # Skip common non-code files
      case "$file" in
        *.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico|*.pdf|*.lock|package-lock.json|yarn.lock)
          continue
          ;;
      esac

      # Check for credential patterns
      if grep -nE "(api[_-]?key|password|secret|token|bearer)\s*[:=]\s*['\"][^'\"]{8,}['\"]" "$file" >> "$CRED_RESULTS" 2>/dev/null; then
        echo -e "${RED}    âœ— Credentials detected in: $file${NC}"
        FAILED=true
      fi
    fi
  done
fi

# Run PHI scan if enabled
if [ "$SCAN_PHI" = "true" ]; then
  echo -e "${BLUE}  â†’ Scanning for PHI...${NC}"

  # Simple PHI pattern matching (MVP)
  # In production, this would call security-compliance-mcp
  git diff --cached --name-only | while read -r file; do
    if [ -f "$file" ]; then
      # Check for PHI patterns
      if grep -nE "(\b\d{3}-\d{2}-\d{4}\b|MRN[:\s]*\d{6,}|patient[_\s]+(id|name|dob))" "$file" >> "$PHI_RESULTS" 2>/dev/null; then
        echo -e "${RED}    âœ— PHI detected in: $file${NC}"
        FAILED=true
      fi
    fi
  done
fi

# If security issues found, block commit
if [ "$FAILED" = "true" ]; then
  echo ""
  echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo -e "${RED}âŒ COMMIT BLOCKED - Security Issues Detected${NC}"
  echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""

  if [ -s "$CRED_RESULTS" ]; then
    echo -e "${YELLOW}ğŸ”‘ Credential Issues:${NC}"
    cat "$CRED_RESULTS" | head -20
    echo ""
  fi

  if [ -s "$PHI_RESULTS" ]; then
    echo -e "${YELLOW}ğŸ¥ PHI Issues:${NC}"
    cat "$PHI_RESULTS" | head -20
    echo ""
  fi

  echo -e "${BLUE}ğŸ“– Remediation Steps:${NC}"
  echo "  1. Remove hard-coded credentials from staged files"
  echo "  2. Use environment variables or secure configuration"
  echo "  3. Remove PHI or use synthetic/anonymized data"
  echo "  4. Review SECURITY_BEST_PRACTICES.md for guidance"
  echo ""
  echo -e "${YELLOW}To bypass this check (NOT RECOMMENDED):${NC}"
  echo "  git commit --no-verify"
  echo ""

  exit 1
fi

echo -e "${GREEN}âœ… Security checks passed${NC}"
echo ""

exit 0
