# Security Guidance for Claude - Proactive Security Integration

This file provides guidance to Claude (the LLM) on when and how to proactively use security tools from the Security & Compliance MCP server.

## Core Principle

**Be proactive, not reactive.** Don't wait for the user to ask about security - automatically suggest and run security checks when appropriate.

## Automatic Security Triggers

### 1. File Creation/Modification Triggers

**ALWAYS scan automatically when:**

#### Working with Configuration Files
- Creating or modifying: `.env`, `.env.*`, `config.*`, `*.config.{js,ts,json}`
- Action: Immediately scan for credentials with high confidence threshold
```typescript
{
  "tool": "scan_for_credentials",
  "params": {
    "target": "${file_path}",
    "mode": "file",
    "minConfidence": 0.8
  }
}
```

#### Working with API Integration Files
- Creating files with: `api`, `client`, `service`, `auth`, `token` in name
- Action: Scan for exposed credentials
```typescript
{
  "tool": "scan_for_credentials",
  "params": {
    "target": "${file_path}",
    "mode": "file",
    "minConfidence": 0.7
  }
}
```

#### Working with Patient Data
- Creating files with: `patient`, `medical`, `health`, `phi`, `hipaa` in path or name
- Action: Scan for PHI with high sensitivity
```typescript
{
  "tool": "scan_for_phi",
  "params": {
    "target": "${file_path}",
    "mode": "file",
    "sensitivity": "high"
  }
}
```

### 2. Git Operation Triggers

**Before ANY commit:**
- Always suggest running security checks on staged files
- Block if violations found
```typescript
// Run both scans
[
  {
    "tool": "scan_for_credentials",
    "params": { "mode": "staged" }
  },
  {
    "tool": "scan_for_phi",
    "params": { "mode": "staged", "sensitivity": "medium" }
  }
]
```

**Before creating pull request:**
- Run comprehensive directory scan
- Check secret rotation status

### 3. Development Workflow Triggers

**After installing new dependencies:**
- Scan package.json and lock files for exposed tokens
- Example: User runs `npm install @stripe/stripe-js`
- You should automatically: "Let me scan for any exposed API keys..."

**When user mentions:**
- "API key", "token", "password", "credentials", "secret"
- Immediately suggest: "I'll help you store that securely using the secrets manager"

**When implementing authentication:**
- Proactively suggest pre-commit hooks
- Automatically scan auth files after creation

### 4. Goal/Task-Based Triggers

**When starting a new goal involving:**
- API integrations → Check secrets management setup
- Patient data → Review HIPAA requirements
- Authentication → Install pre-commit hooks
- Database → Scan connection strings

## Proactive Workflow Examples

### Example 1: API Integration Workflow

```
User: "Add Stripe payment integration"

Claude: "I'll set up Stripe integration with security best practices.

First, let me check if you have secrets management configured..."
→ Calls: manage_secrets with action="status"

"Now I'll create the integration files..."
→ Creates: src/services/stripe-client.ts

"Let me scan this file for security issues..."
→ Calls: scan_for_credentials on new file

"I notice you'll need to store your Stripe API key. Would you like me to:
1. Encrypt it using the secrets manager
2. Add it to the allow-list if it's a test key
3. Update your .env.example with a placeholder"
```

### Example 2: Patient Data Workflow

```
User: "Create a patient registration form"

Claude: "I'll create a patient registration form with HIPAA compliance in mind.

Let me start by creating the data types..."
→ Creates: src/types/patient.ts

"Since this involves patient data, I'm automatically scanning for PHI exposure..."
→ Calls: scan_for_phi with sensitivity="high"

"I found potential PHI in the file (SSN, date of birth). Here are my recommendations:
1. Never commit actual patient data
2. Use test data generators for development
3. Consider de-identification for non-production environments

Would you like me to:
- Add this to the security allow-list with proper justification?
- Set up pre-commit hooks to prevent PHI from being committed?
- Create sanitized test fixtures?"
```

### Example 3: Pre-Commit Workflow

```
User: "I'm ready to commit my changes"

Claude: "Before committing, let me run security checks on your staged files...

Checking for exposed credentials..."
→ Calls: scan_for_credentials with mode="staged"

"Checking for PHI..."
→ Calls: scan_for_phi with mode="staged"

✅ No security violations found. Safe to commit!

Would you like me to create the commit for you?"
```

### Example 4: Secret Rotation Workflow

```
User starts work session

Claude: "Good morning! Let me check your security status...

Checking secret rotation..."
→ Calls: manage_secrets with action="status"

"⚠️ Alert: Your GitHub token is expiring in 3 days.

Would you like me to:
1. Guide you through rotating it
2. Create a reminder task
3. Update the rotation schedule"
```

## Decision Tree for Security Tool Usage

```
File Operation Detected
├─ Contains "patient", "medical", "phi" in path?
│  └─ YES → scan_for_phi (sensitivity=high)
├─ Contains ".env", "config", "api" in name?
│  └─ YES → scan_for_credentials (minConfidence=0.8)
├─ File extension is .ts, .js, .json?
│  └─ YES → scan_for_credentials (minConfidence=0.7)
└─ Otherwise → No automatic scan

Git Operation Detected
├─ Committing?
│  └─ scan_for_credentials + scan_for_phi (staged mode)
├─ Creating PR?
│  └─ Full directory scan + secret rotation check
└─ Otherwise → No action

User Mentions Security Terms
├─ "api key", "token", "password", "secret"
│  └─ Suggest manage_secrets (encrypt)
├─ "patient", "medical record", "phi"
│  └─ Discuss HIPAA compliance + scan_for_phi
├─ "commit", "push", "deploy"
│  └─ Run security checks first
└─ Otherwise → No action

Development Phase
├─ Starting new goal with "api", "auth"
│  └─ Check manage_secrets status + install hooks
├─ Starting goal with "patient", "medical"
│  └─ Review HIPAA requirements + enable PHI scanning
├─ Completing goal
│  └─ Final security audit before closure
└─ Otherwise → Follow normal workflow
```

## Communication Patterns

### Be Clear and Proactive

❌ **DON'T:**
"Would you like me to check for security issues?"

✅ **DO:**
"Let me scan this file for security issues... [scanning]"

### Explain Why

Always explain why you're running a security check:
- "Since this file handles API keys, I'm scanning for exposed credentials..."
- "This involves patient data, so I'm checking for PHI with high sensitivity..."
- "Before committing, let me verify no secrets are being committed..."

### Provide Actionable Results

When violations found:
```
⚠️ Security Issue Found

File: src/config.ts:12
Issue: AWS Access Key detected
Severity: Critical

Recommended actions:
1. Remove the hardcoded key
2. Store in secrets manager: manage_secrets action="encrypt"
3. Reference via environment variable
4. Add to .gitignore if local config file

Would you like me to help fix this?
```

When clean:
```
✅ Security Check Complete

Files scanned: 3
Violations found: 0
Status: Safe to proceed

Audit log: All scans recorded for compliance
```

## Integration with Other MCP Servers

### With Project Management MCP

When project management server creates a goal:
1. Identify security requirements based on goal description
2. Suggest appropriate security checkpoints
3. Automatically scan files created for the goal
4. Verify security before marking goal complete

### With Spec-Driven MCP

When specification is created:
1. Review spec for security requirements
2. Identify if feature handles credentials or PHI
3. Add security tasks to the task list
4. Set up appropriate scanning triggers

### With Task Executor MCP

When task workflow completes:
1. Scan all modified files
2. Run appropriate security checks
3. Verify no violations before archiving workflow
4. Log all security checks to audit trail

## Secret Management Best Practices

**When user provides a credential:**

1. Never log it in plaintext
2. Immediately offer to encrypt it:
```
"I'll encrypt that securely using the secrets manager..."
→ manage_secrets action="encrypt" key="api_key" value="${secret}"
```

3. Remind about rotation:
```
"I've stored your API key with 90-day rotation. I'll remind you when it needs updating."
```

**When checking status:**

Proactively check daily:
```
→ manage_secrets action="status"

If expiring/expired:
"⚠️ You have ${count} secrets needing rotation:
- github_token (expires in 3 days)
- aws_key (expired 5 days ago)

Would you like to rotate these now?"
```

## Pre-Commit Hook Management

**When to suggest installing:**
- User creates new repository
- User mentions committing code
- User starts project with sensitive data
- After first security violation found

**How to suggest:**
```
"I recommend installing a pre-commit security hook to automatically catch issues before they're committed.

This will:
- Scan staged files for credentials
- Check for PHI exposure
- Block commits with violations
- Maintain complete audit trail

Install now? (Takes 5 seconds)"
```

## Allow-List Management

**When to suggest adding to allow-list:**
- False positive confirmed by user
- Test fixtures with fake data
- Example code with dummy credentials
- Documentation with sample values

**How to suggest:**
```
"This appears to be a false positive. Would you like me to add it to the allow-list?

I'll document:
- File: tests/fixtures/sample-api.ts
- Pattern: Generic API Key
- Reason: Test fixture with fake credentials for unit tests
- Added by: ${user}

This will prevent future alerts for this specific case."
```

## Audit Compliance

**Automatically track in audit log:**
- Every security scan performed
- Every violation detected
- Every secret operation (encrypt/decrypt/rotate)
- Every PHI access event
- Every pre-commit hook execution

**Monthly compliance reminder:**
```
"It's been 30 days since the last compliance review.

Summary:
- Security scans: 127
- Violations found: 3 (all resolved)
- PHI scans: 15
- Secrets rotated: 2

Would you like me to generate a compliance report?"
```

## Error Handling

**If security scan fails:**
1. Don't block the user
2. Log the error
3. Suggest manual verification
4. Provide workaround

```
"Security scan encountered an error, but I won't block your progress.

Error: [details]

Recommended:
1. Manually review the file for sensitive data
2. Check audit log: ~/.security-compliance-mcp/audit-logs
3. Try running the scan again

Proceed with caution."
```

## Summary

**Key Principles:**
1. **Proactive, not reactive** - Don't wait to be asked
2. **Context-aware** - Recognize security-sensitive operations
3. **Explain clearly** - Tell user why you're scanning
4. **Action-oriented** - Provide clear next steps
5. **Integrated** - Work seamlessly with other MCP servers
6. **Compliant** - Maintain audit trail for everything

**Remember:** Security should feel helpful, not obstructive. Make it easy for users to do the right thing.
