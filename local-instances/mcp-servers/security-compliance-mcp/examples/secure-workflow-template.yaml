# Secure Development Workflow Template
# This template integrates security scanning into standard development workflows

name: secure_feature_development
version: 1.0.0
description: Standard development workflow with integrated security checks for HIPAA-compliant projects

# Workflow phases with security checkpoints
phases:
  - name: planning
    description: Requirements gathering and security planning
    steps:
      - name: create_specification
        mcp_server: spec-driven
        tool: sdd_guide

      - name: identify_security_requirements
        description: Identify if feature handles credentials or PHI
        manual: true
        outputs:
          - handles_credentials
          - handles_phi
          - security_level

  - name: implementation
    description: Feature development with automatic security scanning
    steps:
      - name: create_files
        mcp_server: project-management
        tool: create_feature_files
        outputs:
          - created_files

      - name: scan_for_credentials
        mcp_server: security-compliance-mcp
        tool: scan_for_credentials
        required: true
        params:
          mode: file
          target: "${created_files}"
          minConfidence: 0.7
        on_violation: block
        skip_if: "${handles_credentials} == false"

      - name: scan_for_phi
        mcp_server: security-compliance-mcp
        tool: scan_for_phi
        required: true
        params:
          mode: file
          target: "${created_files}"
          sensitivity: high
        on_violation: block
        skip_if: "${handles_phi} == false"

  - name: testing
    description: Testing with security validation
    steps:
      - name: run_unit_tests
        mcp_server: task-executor
        tool: run_tests

      - name: full_security_audit
        mcp_server: security-compliance-mcp
        description: Comprehensive security scan of feature files
        parallel:
          - name: credential_scan
            tool: scan_for_credentials
            params:
              mode: directory
              target: "./src"
              exclude: ["node_modules", "build", "tests/fixtures"]

          - name: phi_scan
            tool: scan_for_phi
            params:
              mode: directory
              target: "./src"
              sensitivity: high

        on_violation: block

  - name: review
    description: Code review with security verification
    steps:
      - name: create_pull_request
        mcp_server: project-management
        tool: create_pr

      - name: pre_pr_security_scan
        mcp_server: security-compliance-mcp
        description: Final security scan before PR merge
        parallel:
          - tool: scan_for_credentials
            params:
              mode: commit
              commitHash: "${pr_commit_hash}"
              minConfidence: 0.5

          - tool: scan_for_phi
            params:
              mode: commit
              commitHash: "${pr_commit_hash}"
              sensitivity: medium

        required: true
        on_violation: block

  - name: deployment
    description: Pre-deployment security validation
    steps:
      - name: check_secret_rotation
        mcp_server: security-compliance-mcp
        tool: manage_secrets
        params:
          action: status
        alert_on: ["expiring", "expired"]

      - name: final_security_check
        mcp_server: security-compliance-mcp
        description: Final pre-deployment security verification
        required: true
        parallel:
          - tool: scan_for_credentials
            params:
              mode: directory
              target: "."
              exclude: ["node_modules", "build", "dist", "tests"]

          - tool: scan_for_phi
            params:
              mode: directory
              target: "."
              sensitivity: high

        on_violation: block

      - name: deploy
        mcp_server: project-management
        tool: deploy_feature
        requires: [final_security_check]

# Security automation rules
security_rules:
  - name: auto_scan_on_save
    trigger: file_saved
    file_patterns:
      - "**/*.ts"
      - "**/*.js"
      - "**/*.json"
    exclude:
      - "node_modules/**"
      - "build/**"
      - "tests/fixtures/**"
    action:
      tool: scan_for_credentials
      params:
        mode: file
        minConfidence: 0.7

  - name: auto_scan_patient_files
    trigger: file_saved
    file_patterns:
      - "**/patient*/**/*"
      - "**/medical-records/**/*"
    action:
      tool: scan_for_phi
      params:
        mode: file
        sensitivity: high

  - name: block_commits_with_violations
    trigger: pre_commit
    action:
      parallel:
        - tool: scan_for_credentials
          params:
            mode: staged
        - tool: scan_for_phi
          params:
            mode: staged
            sensitivity: medium
      on_violation: block

# Compliance requirements
compliance:
  hipaa:
    enabled: true
    requirements:
      - phi_tracking: true
      - audit_retention_days: 2190
      - pre_commit_phi_scan: true
      - pre_deploy_phi_scan: true

  security:
    credential_scanning:
      enabled: true
      min_confidence: 0.5
      block_on_critical: true

    phi_protection:
      enabled: true
      sensitivity: medium
      block_on_violations: true

# Notification configuration
notifications:
  on_security_violation:
    enabled: true
    severity_threshold: high
    channels:
      - audit_log
      - workflow_log

  on_phi_detected:
    enabled: true
    channels:
      - audit_log

  on_secret_rotation_needed:
    enabled: true
    warning_days: 7
    channels:
      - workflow_log

# Workflow metadata
metadata:
  author: Security Team
  created: 2025-01-28
  updated: 2025-01-28
  version: 1.0.0
  tags:
    - security
    - hipaa
    - automated-scanning
